---
phase: 14-blood-work-schedule
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/calendar/blood-work-calendar.tsx
  - src/app/(dashboard)/patient/blood-work-schedule/page.tsx
autonomous: false
---

<objective>
Create calendar view for patient blood work schedule.

Purpose: Patients can visualize their upcoming blood work appointments in a calendar format, see details about scheduled labs, and understand their testing timeline.

Output: Working blood work schedule page with list/calendar toggle showing scheduled blood work appointments.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-refill-calendar/13-RESEARCH.md

@src/app/(dashboard)/patient/refills/page.tsx
@src/components/calendar/refill-calendar.tsx
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BloodWorkCalendar client component</name>
  <files>src/components/calendar/blood-work-calendar.tsx</files>
  <action>
Create a client component that displays blood work appointments as calendar events.

**CRITICAL: Use controlled state pattern (from Phase 13 RESEARCH.md) to fix Next.js navigation button issues:**
- Use useState for both `date` and `view`
- Use useCallback for `onNavigate` and `onView` handlers
- Pass controlled values to Calendar component

**Implementation:**
1. Mark as 'use client'
2. Import from react-big-calendar: Calendar, dateFnsLocalizer, View, Views
3. Import date-fns functions: format, parse, startOfWeek, getDay
4. Import enUS locale from date-fns/locale/en-US
5. Import the CSS: 'react-big-calendar/lib/css/react-big-calendar.css'
6. Create localizer with dateFnsLocalizer({ format, parse, startOfWeek, getDay, locales: { 'en-US': enUS } })
7. Define BloodWorkEvent interface: { id: string, title: string, start: Date, end: Date, allDay: boolean, type: 'scheduled' | 'completed', status: AppointmentStatus, data?: Appointment }
8. Props: { events: BloodWorkEvent[], onSelectEvent?: (event: BloodWorkEvent) => void }
9. Use controlled state: const [date, setDate] = useState(new Date()); const [view, setView] = useState<View>(Views.MONTH)
10. Create memoized handlers: onNavigate = useCallback((newDate) => setDate(newDate), []); onView = useCallback((newView) => setView(newView), [])
11. Create eventPropGetter to color events:
    - scheduled: orange (hsl(25 95% 53%)) for upcoming blood work
    - completed: green (hsl(142 76% 36%)) for past completed blood work
12. Container must have explicit height: className="h-[600px]"
13. Enable views: [Views.MONTH, Views.WEEK, Views.AGENDA]
14. Enable popup for overflow events
15. Pass onSelectEvent to calendar for click handling

**DO NOT:**
- Use uncontrolled component (navigation buttons will break)
- Forget 'use client' directive
- Forget to import the CSS file
- Create container without height (calendar won't render)
  </action>
  <verify>TypeScript compiles: `cd phc-health-club && npx tsc --noEmit`</verify>
  <done>BloodWorkCalendar component created with controlled state, date-fns localizer, and event type styling</done>
</task>

<task type="auto">
  <name>Task 2: Create blood work schedule page</name>
  <files>src/app/(dashboard)/patient/blood-work-schedule/page.tsx</files>
  <action>
Create the blood work schedule page with list/calendar view toggle.

**Implementation:**
1. Server component for data fetching
2. Fetch appointments where type = 'bloodwork' for the logged-in patient
3. Fetch completed blood_work records to also display on calendar
4. Import Tabs components from @/components/ui/tabs
5. Import BloodWorkCalendar from @/components/calendar/blood-work-calendar
6. Import List and Calendar icons from lucide-react
7. Import Dialog components for event details popup

**Data fetching:**
```typescript
// Get bloodwork appointments (scheduled)
const { data: bloodworkAppointments } = await supabase
  .from('appointments')
  .select('*, provider:providers(user:users(first_name, last_name))')
  .eq('patient_id', patient?.id)
  .eq('type', 'bloodwork')
  .order('datetime', { ascending: true });

// Get completed blood work for reference
const { data: completedBloodWork } = await supabase
  .from('blood_work')
  .select('id, date')
  .eq('patient_id', patient?.id)
  .order('date', { ascending: false });
```

**Transform functions:**
- transformAppointmentsToEvents: Map appointments to calendar events with type 'scheduled'
- transformBloodWorkToEvents: Map completed blood_work to events with type 'completed'

**List view content:**
- Card for each upcoming blood work appointment showing:
  - Date/time
  - Provider name (if available)
  - Status badge (scheduled, completed, cancelled)
  - Info text: "Your provider will be ordering new labs on this date"
- Section for past completed blood work with links to results

**Calendar view:**
- BloodWorkCalendar with combined events
- OnSelectEvent opens Dialog showing appointment/blood work details

**Page structure:**
- PageHeader with title "Blood Work Schedule" and description
- Tabs with "List View" and "Calendar View"
- TabsContent for each view

**DO NOT:**
- Convert page.tsx to client component (keep server-side data fetching)
- Remove ability to see completed blood work
- Forget empty state handling
  </action>
  <verify>
1. `cd phc-health-club && npm run build` succeeds
2. No TypeScript errors
  </verify>
  <done>Blood work schedule page has list and calendar views showing scheduled appointments and completed blood work</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation link to patient sidebar</name>
  <files>src/app/(dashboard)/layout.tsx</files>
  <action>
Add "Blood Work Schedule" link to the patient sidebar navigation.

**Implementation:**
1. Find the patient navigation items in the dashboard layout
2. Add new navigation item after "Blood Work" (existing results page):
   - Label: "Lab Schedule"
   - Icon: CalendarDays from lucide-react
   - Href: /patient/blood-work-schedule
3. Keep it visually grouped with other blood work related links

**DO NOT:**
- Remove existing navigation items
- Change the order of other navigation links
- Use a confusing icon
  </action>
  <verify>Visual inspection - navigation link appears in sidebar</verify>
  <done>Blood work schedule link added to patient sidebar navigation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Blood work schedule page with calendar and list views showing scheduled blood work appointments</what-built>
  <how-to-verify>
    1. Run: cd phc-health-club && npm run dev
    2. Login as a patient
    3. Check sidebar: "Lab Schedule" link should be visible
    4. Navigate to: http://localhost:3000/patient/blood-work-schedule
    5. Verify: Two tabs visible - "List View" and "Calendar View"
    6. Click "List View" tab: Shows scheduled blood work info (or empty state if none)
    7. Click "Calendar View" tab: Calendar renders with month view
    8. Test calendar navigation:
       - Click "Today" button - should work
       - Click "Back" and "Next" buttons - should navigate months
       - Click "Month", "Week", "Agenda" buttons - should switch views
    9. If appointments with type='bloodwork' exist: Verify events show on calendar with orange color
    10. If completed blood work exists: Should show with green color
    11. Responsive: Resize browser - calendar should remain usable
    12. No console errors in browser DevTools
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] Calendar component renders
- [ ] Navigation buttons work (controlled state pattern)
- [ ] Tab switching works
- [ ] Navigation link in sidebar works
- [ ] Events display correctly (if data exists)
</verification>

<success_criteria>
- All tasks completed
- Blood work schedule page displays appointments and completed blood work
- Tab navigation between list and calendar views works
- Calendar navigation buttons functional
- Sidebar navigation link works
- Visual verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/14-blood-work-schedule/14-01-SUMMARY.md`
</output>
