---
phase: 09-blood-work-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/components/ui/chart.tsx
  - src/lib/utils/biomarker-utils.ts
  - src/components/blood-work/biomarker-chart.tsx
  - src/components/blood-work/biomarker-card.tsx
  - src/app/(dashboard)/patient/blood-work/[id]/page.tsx
autonomous: true
---

<objective>
Implement blood work history with interactive biomarker charts and trend analysis.

Purpose: Allow patients to visualize their biomarker trends over time with reference range context, making it easier to understand their health progress.
Output: Detail page at /patient/blood-work/[id] with biomarker charts showing historical values and reference ranges.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-blood-work-history/09-RESEARCH.md

# Existing blood work implementation:
@src/app/(dashboard)/patient/blood-work/page.tsx
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup Recharts dependencies and biomarker utilities</name>
  <files>package.json, src/components/ui/chart.tsx, src/lib/utils/biomarker-utils.ts</files>
  <action>
1. Add react-is for React 19 compatibility:
   - npm install react-is@19.2.3
   - Add overrides to package.json: "overrides": { "react-is": "$react-is" }

2. Add shadcn/ui chart component:
   - npx shadcn@latest add chart
   - This creates src/components/ui/chart.tsx with ChartContainer, ChartTooltip, ChartTooltipContent, ChartLegend, ChartLegendContent

3. Create biomarker utility functions at src/lib/utils/biomarker-utils.ts:
   - getBiomarkerTrend(records: BloodWork[], biomarkerKey: string): { date: string; value: number }[]
     Transform blood_work records into chart-ready format, sorted by date ascending
   - getUniqueBiomarkers(records: BloodWork[]): string[]
     Extract unique biomarker names from all records
   - calculateTrendChange(current: number, previous: number): { direction: 'up' | 'down' | 'stable'; percent: number }
     Calculate percentage change between values (stable if < 2% change)
   - getBiomarkerStatus(value: number, refLow: number | null, refHigh: number | null): 'normal' | 'low' | 'high' | null
     Determine if value is within reference range

Use date-fns format() for date formatting (already installed).
Import types from @/types/database.
  </action>
  <verify>
- npm run build succeeds
- chart.tsx exists in src/components/ui/
- biomarker-utils.ts exports all 4 functions with proper TypeScript types
  </verify>
  <done>
- react-is installed with overrides configured
- shadcn chart component added
- Biomarker utility functions created and typed
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BiomarkerChart and BiomarkerCard components</name>
  <files>src/components/blood-work/biomarker-chart.tsx, src/components/blood-work/biomarker-card.tsx</files>
  <action>
1. Create BiomarkerChart at src/components/blood-work/biomarker-chart.tsx:
   - "use client" directive (Recharts requires client component)
   - Props: data (array of {date, value}), referenceRange ({low, high}), unit, biomarkerName
   - Use LineChart from recharts with:
     - CartesianGrid (strokeDasharray="3 3", vertical={false})
     - XAxis (dataKey="date", no tick/axis lines)
     - YAxis (with unit, no tick/axis lines)
     - ReferenceArea for normal range (y1=low, y2=high, green fillOpacity=0.1)
     - Line (type="monotone", strokeWidth=2, dots)
     - ChartTooltip from shadcn
   - Wrap in ChartContainer with min-h-[200px]
   - Define chartConfig for theming

2. Create BiomarkerCard at src/components/blood-work/biomarker-card.tsx:
   - Props: name, value, unit, previousValue (optional), referenceRange, flag
   - Display biomarker name with flag badge (high=destructive, low=secondary, normal=default)
   - Show value with unit
   - If previousValue provided, show trend indicator:
     - TrendingUp icon (green) if increased
     - TrendingDown icon (red) if decreased
     - Minus icon if stable
     - Show percentage change
   - Show reference range at bottom
   - Use existing Badge component from shadcn
   - Use Lucide icons (TrendingUp, TrendingDown, Minus)
  </action>
  <verify>
- npm run build succeeds
- Both components export properly
- No TypeScript errors
  </verify>
  <done>
- BiomarkerChart renders line chart with reference area
- BiomarkerCard shows value with trend indicator
- Both components use shadcn theming
  </done>
</task>

<task type="auto">
  <name>Task 3: Create blood work detail page with charts</name>
  <files>src/app/(dashboard)/patient/blood-work/[id]/page.tsx</files>
  <action>
Create detail page at src/app/(dashboard)/patient/blood-work/[id]/page.tsx:

1. Server component structure:
   - Auth check (redirect if not patient)
   - Fetch single blood_work record by ID
   - Fetch ALL blood_work records for this patient (for trend data)
   - Use getBiomarkerTrend() to prepare chart data for each biomarker

2. Page layout:
   - PageHeader with date and lab source, back button to /patient/blood-work
   - If PDF exists, show "View PDF" button
   - Notes section if record has notes

3. Biomarkers section:
   - Grid of BiomarkerCard components for each biomarker in record
   - Each card shows current value, flag, reference range
   - Include trend data from previous records

4. Charts section:
   - For each biomarker in the record, show BiomarkerChart
   - Pass trend data (all historical values for that biomarker)
   - Pass reference range from BiomarkerValue
   - Use Tabs component to organize charts (one tab per biomarker) OR
   - Show as expandable accordion for each biomarker

5. Handle edge cases:
   - Record not found: show "Blood work not found" with back link
   - No biomarkers: show message "No biomarker data available"
   - Single data point: chart still renders (no trend line, just dot)

Use existing patterns from blood-work/page.tsx for auth and data fetching.
  </action>
  <verify>
- npm run build succeeds
- Navigate to /patient/blood-work/[id] shows detail page
- Charts render with data (if blood_work records exist)
- Back navigation works
  </verify>
  <done>
- Detail page shows full blood work record
- Biomarker cards display with trends
- Charts visualize historical data with reference ranges
- Navigation between list and detail works
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] npm run lint passes (or only pre-existing warnings)
- [ ] Chart renders at /patient/blood-work/[id] (test with real or mock data)
- [ ] Reference range bands visible in charts
- [ ] Trend indicators show correctly on biomarker cards
- [ ] Back navigation from detail to list works
</verification>

<success_criteria>

- All 3 tasks completed
- All verification checks pass
- No new TypeScript errors introduced
- Blood work detail page shows biomarker charts with reference ranges
- Trend analysis visible (percent change vs previous)
- Patient can navigate between list and detail views
</success_criteria>

<output>
After completion, create `.planning/phases/09-blood-work-history/09-01-SUMMARY.md`
</output>
