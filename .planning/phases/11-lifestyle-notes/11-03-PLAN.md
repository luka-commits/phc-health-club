---
phase: 11-lifestyle-notes
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/lib/actions/body-metrics.ts
  - src/app/(dashboard)/patient/body-metrics/page.tsx
  - src/components/body-metrics/BodyMetricsChart.tsx
autonomous: true
---

<objective>
Build the Body Metrics page where patients track weight and body measurements with visual trend charts.

Purpose: Hormone therapy patients need to see physical progress over time â€” weight and circumference trends are key indicators that treatment is working.
Output: Body metrics page with add form, current values display, and Recharts line charts for trends.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-lifestyle-notes/11-CONTEXT.md

@src/types/database.ts
@src/lib/actions/lifestyle.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create body metrics server actions</name>
  <files>src/lib/actions/body-metrics.ts</files>
  <action>
Create server actions following established patterns:

**createBodyMetric(input: CreateBodyMetricInput)**
Input type:
```typescript
interface CreateBodyMetricInput {
  measuredAt: string;
  weightLbs?: number;
  chestInches?: number;
  waistInches?: number;
  hipInches?: number;
  armInches?: number;
  thighInches?: number;
  notes?: string;
}
```
- Validate at least one measurement is provided
- Get patient.id from authenticated user
- Insert into body_metrics
- revalidatePath('/patient/body-metrics')

**getBodyMetrics()**
- Returns ActionResult<BodyMetric[]>
- Query body_metrics for current patient
- Order by measured_at DESC
- Limit to last 50 records for chart performance

**getLatestBodyMetric()**
- Returns ActionResult<BodyMetric | null>
- Query single most recent body_metrics record
- Used for "current values" display
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>Three server actions exported: createBodyMetric, getBodyMetrics, getLatestBodyMetric</done>
</task>

<task type="auto">
  <name>Task 2: Create body metrics chart component</name>
  <files>src/components/body-metrics/BodyMetricsChart.tsx</files>
  <action>
Create client component using Recharts (already installed):

**Props:**
```typescript
interface BodyMetricsChartProps {
  data: BodyMetric[];
  metric: 'weight_lbs' | 'chest_inches' | 'waist_inches' | 'hip_inches' | 'arm_inches' | 'thigh_inches';
  label: string;
  color?: string;
}
```

**Implementation:**
- "use client" directive (required for Recharts)
- Transform data: filter nulls, format dates, sort ascending by date
- Use LineChart with:
  - XAxis showing dates (format: "MMM d")
  - YAxis with appropriate domain
  - Tooltip showing exact value and date
  - Line with smooth curve (type="monotone")
  - ResponsiveContainer for responsive sizing
- Handle empty data with "No data yet" message
- Use Tailwind colors (e.g., hsl(var(--primary)))
  </action>
  <verify>Component imports and exports correctly</verify>
  <done>BodyMetricsChart component renders line chart for any metric type</done>
</task>

<task type="auto">
  <name>Task 3: Create body metrics page</name>
  <files>src/app/(dashboard)/patient/body-metrics/page.tsx</files>
  <action>
Create page with form and charts:

**Layout:**
- PageHeader with title "Body Metrics" and description about tracking progress
- Current values card at top showing latest measurements
- Add measurement form (client component)
- Charts section below

**Current Values Card:**
- Display latest weight and circumferences
- Show date of last measurement
- "No measurements yet" if empty

**Add Measurement Form (client component inline or separate):**
- Date picker (measured_at, default today)
- Weight input (number, lbs)
- Circumference inputs in collapsible section:
  - Chest, Waist, Hip, Arm, Thigh (all optional)
- Notes textarea (optional)
- Submit button with pending state
- All fields optional except date, but require at least one measurement

**Charts Section:**
- Tabs or dropdown to switch between metrics
- Default to weight chart
- Show chart for selected metric using BodyMetricsChart
- 6 options: Weight, Chest, Waist, Hip, Arm, Thigh

Use existing patterns:
- Server component fetches data, passes to client components
- Client form calls server action
- useTransition for pending state
- sonner toast for feedback
  </action>
  <verify>npm run build succeeds</verify>
  <done>Body metrics page at /patient/body-metrics with form and charts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Server actions handle auth and validation
- [ ] Chart component renders without errors
- [ ] Page displays current values and form
- [ ] Form submission saves to database
- [ ] Charts show trend data
- [ ] `npm run build` succeeds
</verification>

<success_criteria>

- Server actions created in src/lib/actions/body-metrics.ts
- Chart component created in src/components/body-metrics/
- Body metrics page at /patient/body-metrics
- Patients can add measurements
- Trend charts display using Recharts
- No build errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-lifestyle-notes/11-03-SUMMARY.md`
</output>
