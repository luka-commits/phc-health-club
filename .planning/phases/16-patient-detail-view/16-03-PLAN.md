---
phase: 16-patient-detail-view
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/app/(dashboard)/provider/patients/[id]/page.tsx
  - src/components/provider/patient-detail/blood-work-tab.tsx
  - src/components/provider/patient-detail/blood-work-chart.tsx
autonomous: true
---

<objective>
Add Blood Work tab with history list and biomarker charts.

Purpose: Provider can view patient's complete blood work history and track biomarkers over time.
Output: Blood Work tab displays all lab results with expandable details and trend charts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context
@.planning/phases/16-patient-detail-view/16-01-SUMMARY.md

# Existing blood work patterns
@src/app/(dashboard)/patient/blood-work/page.tsx
@src/app/(dashboard)/patient/blood-work/[id]/page.tsx
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BloodWorkTab component</name>
  <files>src/components/provider/patient-detail/blood-work-tab.tsx</files>
  <action>
Create component that displays blood work history for a patient:

1. Props: bloodWorkRecords: BloodWork[] (already fetched from server)

2. If no records:
   - Show EmptyState with TestTube icon
   - "No Blood Work Records" message

3. If records exist, show:
   a. Summary stats at top:
      - Total records count
      - Date range (oldest to newest)
      - Most recent date

   b. Records list (similar to patient view but more provider-focused):
      - Date with formatted display
      - Lab source badge (Quest/Labcorp/Other)
      - PDF link if available (opens in new tab)
      - Quick biomarker preview (top 4 with flags)
      - Expandable section to see all biomarkers
      - Notes if present

   c. Search/filter input:
      - Search by biomarker name (filters the displayed records to those containing that biomarker)

Use Collapsible for expandable biomarker sections.
Follow pattern from patient blood work page but add search capability.
  </action>
  <verify>Component displays blood work records with expandable details</verify>
  <done>BloodWorkTab shows all records with biomarker search</done>
</task>

<task type="auto">
  <name>Task 2: Create BloodWorkChart component</name>
  <files>src/components/provider/patient-detail/blood-work-chart.tsx</files>
  <action>
Create chart component for visualizing biomarker trends:

1. Props:
   - bloodWorkRecords: BloodWork[]
   - selectedBiomarker: string (biomarker name to chart)

2. Functionality:
   - Extract selected biomarker values across all records
   - Sort by date ascending
   - Display as Line chart using Recharts (already installed)
   - X-axis: dates
   - Y-axis: values with unit
   - Show reference range as shaded area if available
   - Tooltip showing exact value, date, and flag

3. Biomarker selector:
   - Dropdown to choose which biomarker to display
   - Populate from unique biomarkers across all records
   - Default to first common biomarker (or "Testosterone" if exists)

4. Handle cases:
   - Not enough data points (need at least 2)
   - Selected biomarker not in any records

Use "use client" directive (Recharts requires client-side).
Follow existing Recharts patterns from body-metrics charts.
  </action>
  <verify>Chart renders biomarker trends correctly, selector works</verify>
  <done>BloodWorkChart displays selected biomarker trend over time</done>
</task>

<task type="auto">
  <name>Task 3: Integrate blood work into detail page</name>
  <files>src/app/(dashboard)/provider/patients/[id]/page.tsx</files>
  <action>
Update the patient detail page to:

1. Fetch blood work data in server component:
   - Query blood_work table for this patient
   - Order by date descending
   - Include all fields (biomarkers, pdf_url, notes, etc.)

2. Update "Blood Work" TabsContent:
   - Two-column layout on large screens (list + chart)
   - BloodWorkTab on left (or top on mobile)
   - BloodWorkChart on right (or bottom on mobile)
   - State management to sync selected biomarker between list and chart

3. Remove placeholder text from Blood Work tab

4. Create client wrapper if needed for state sharing between components

Consider: May need a client wrapper component (BloodWorkSection) to manage shared state for selected biomarker between list and chart.
  </action>
  <verify>Blood Work tab shows history list and charts side by side</verify>
  <done>Blood Work tab fully functional with synchronized list and chart</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Blood Work tab displays all records
- [ ] PDF links work (open in new tab)
- [ ] Biomarker details expandable
- [ ] Chart shows trend for selected biomarker
- [ ] Biomarker selector updates chart
- [ ] Empty states handle no data
- [ ] Responsive layout works
</verification>

<success_criteria>
- Blood work history visible with all details
- Charts visualize biomarker trends over time
- Provider can search and filter biomarkers
- PDF downloads accessible
</success_criteria>

<output>
After completion, create `.planning/phases/16-patient-detail-view/16-03-SUMMARY.md`
</output>
