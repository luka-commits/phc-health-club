---
phase: 13-refill-calendar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/calendar/refill-calendar.tsx
  - src/app/(dashboard)/patient/refills/page.tsx
  - src/app/globals.css
autonomous: false
---

<objective>
Create calendar view for patient refill schedule and blood work schedule.

Purpose: Patients can visualize their upcoming refills and blood work appointments in a calendar format, making it easier to track and plan around their treatment schedule.

Output: Working calendar component integrated into the refills page with list/calendar view toggle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-refill-calendar/13-RESEARCH.md

@src/app/(dashboard)/patient/refills/page.tsx
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RefillCalendar client component</name>
  <files>src/components/calendar/refill-calendar.tsx</files>
  <action>
Create a client component that displays prescription refills and blood work as calendar events.

**CRITICAL: Use controlled state pattern (from RESEARCH.md) to fix Next.js navigation button issues:**
- Use useState for both `date` and `view`
- Use useCallback for `onNavigate` and `onView` handlers
- Pass controlled values to Calendar component

**Implementation:**
1. Mark as 'use client'
2. Import from react-big-calendar: Calendar, dateFnsLocalizer, View, Views
3. Import date-fns functions: format, parse, startOfWeek, getDay
4. Import enUS locale from date-fns/locale/en-US
5. Import the CSS: 'react-big-calendar/lib/css/react-big-calendar.css'
6. Create localizer with dateFnsLocalizer({ format, parse, startOfWeek, getDay, locales: { 'en-US': enUS } })
7. Define CalendarEvent interface: { id: string, title: string, start: Date, end: Date, allDay: boolean, type: 'refill' | 'bloodwork', data?: unknown }
8. Props: { events: CalendarEvent[] }
9. Use controlled state: const [date, setDate] = useState(new Date()); const [view, setView] = useState<View>(Views.MONTH)
10. Create memoized handlers: onNavigate = useCallback((newDate) => setDate(newDate), []); onView = useCallback((newView) => setView(newView), [])
11. Create eventPropGetter to color events: refill = green (hsl(142 76% 36%)), bloodwork = orange (hsl(25 95% 53%))
12. Container must have explicit height: className="h-[600px]"
13. Enable views: [Views.MONTH, Views.WEEK, Views.AGENDA]
14. Enable popup for overflow events

**DO NOT:**
- Use uncontrolled component (navigation buttons will break)
- Forget 'use client' directive
- Forget to import the CSS file
- Create container without height (calendar won't render)
  </action>
  <verify>TypeScript compiles: `cd phc-health-club && npx tsc --noEmit`</verify>
  <done>RefillCalendar component created with controlled state, date-fns localizer, and event type styling</done>
</task>

<task type="auto">
  <name>Task 2: Integrate calendar into refills page</name>
  <files>src/app/(dashboard)/patient/refills/page.tsx, src/app/globals.css</files>
  <action>
Update the refills page to include both list view (existing) and calendar view with tab navigation.

**Implementation in refills/page.tsx:**
1. Keep as server component for data fetching
2. Import Tabs components from @/components/ui/tabs (TabsContent, TabsList, TabsRoot, TabsTrigger)
3. Import RefillCalendar from @/components/calendar/refill-calendar
4. Import List and Calendar icons from lucide-react
5. Create transformToCalendarEvents function that converts prescriptions to CalendarEvent[]:
   - Filter prescriptions with refill_date
   - Map to: { id: `refill-${id}`, title: `Refill: ${products?.name}`, start: new Date(refill_date), end: new Date(refill_date), allDay: true, type: 'refill', data: prescription }
6. Wrap existing content in Tabs with defaultValue="list"
7. Add TabsList with two triggers: "List View" (List icon) and "Calendar View" (Calendar icon)
8. Put existing prescriptions list in TabsContent value="list"
9. Put RefillCalendar in TabsContent value="calendar" with events={transformToCalendarEvents(prescriptions)}

**Add calendar CSS overrides in globals.css:**
Add Tailwind-compatible styles for react-big-calendar to match shadcn/ui theme:
- .rbc-calendar { font-family: inherit; }
- .rbc-toolbar button styles with Tailwind-like borders and hover states
- .rbc-toolbar button.rbc-active with primary color
- .rbc-today with accent background
- .rbc-header with muted foreground text

**DO NOT:**
- Convert page.tsx to client component (keep server-side data fetching)
- Remove existing list view functionality
- Forget to handle empty state (no prescriptions = empty calendar)
  </action>
  <verify>
1. `cd phc-health-club && npm run build` succeeds
2. No TypeScript errors
  </verify>
  <done>Refills page has tab navigation between list view and calendar view, calendar displays refill events</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Calendar view for refills page with tab navigation between list and calendar views</what-built>
  <how-to-verify>
    1. Run: cd phc-health-club && npm run dev
    2. Login as a patient (or use existing test account)
    3. Navigate to: http://localhost:3000/patient/refills
    4. Verify: Two tabs visible - "List View" and "Calendar View"
    5. Click "List View" tab: Existing refills list displays correctly
    6. Click "Calendar View" tab: Calendar renders with month view
    7. Test calendar navigation:
       - Click "Today" button - should work
       - Click "Back" and "Next" buttons - should navigate months
       - Click "Month", "Week", "Agenda" buttons - should switch views
    8. If prescriptions with refill_date exist: Verify events show on calendar with green color
    9. Responsive: Resize browser - calendar should remain usable
    10. No console errors in browser DevTools
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] Calendar component renders
- [ ] Navigation buttons work (controlled state pattern)
- [ ] Tab switching works
- [ ] Events display correctly (if data exists)
</verification>

<success_criteria>
- All tasks completed
- Calendar displays refill events with proper styling
- Tab navigation between list and calendar views works
- Calendar navigation buttons functional
- Visual verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/13-refill-calendar/13-01-SUMMARY.md`
</output>
