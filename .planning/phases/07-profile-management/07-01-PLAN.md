---
phase: 07-profile-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/patient/settings/actions.ts
  - src/app/(dashboard)/patient/settings/profile-form.tsx
  - src/app/(dashboard)/patient/settings/address-form.tsx
  - src/app/(dashboard)/patient/settings/page.tsx
  - src/lib/validations/profile.ts
autonomous: true
---

<objective>
Make patient profile settings functional with server actions, form validation, and user feedback.

Purpose: Allow patients to update their personal info and addresses - critical for medication delivery.
Output: Working profile and address forms with save functionality, validation, and toast feedback.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-profile-management/07-CONTEXT.md

# Source files to modify:
@src/app/(dashboard)/patient/settings/page.tsx
@src/types/database.ts
@src/lib/supabase/server.ts
@src/lib/supabase/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod validation schemas</name>
  <files>src/lib/validations/profile.ts</files>
  <action>
Create validation schemas for profile and address forms:

1. `profileSchema` - validates first_name, last_name, phone, date_of_birth
   - first_name: required, min 1 char
   - last_name: required, min 1 char
   - phone: optional, but if provided must be valid phone format (10+ digits)
   - date_of_birth: optional, but if provided must be valid date in past

2. `addressSchema` - validates address fields
   - street: required, min 1 char
   - city: required, min 1 char
   - state: required, exactly 2 uppercase letters (US state code)
   - zip: required, 5 digits
   - country: default 'US'

Export TypeScript types inferred from schemas.
  </action>
  <verify>File exists with proper TypeScript types, no compile errors</verify>
  <done>Zod schemas exported for profile and address validation</done>
</task>

<task type="auto">
  <name>Task 2: Create server actions for profile updates</name>
  <files>src/app/(dashboard)/patient/settings/actions.ts</files>
  <action>
Create server actions file with 'use server' directive:

1. `updateProfile(formData: ProfileInput)` action:
   - Get authenticated user via getDBUser()
   - Validate input with profileSchema
   - Update users table (first_name, last_name, phone)
   - Update patients table (date_of_birth)
   - Return { success: true } or { success: false, error: string }

2. `updateShippingAddress(formData: AddressInput)` action:
   - Get authenticated user
   - Validate input with addressSchema
   - Get patient record by user_id
   - Update patients.shipping_address (JSONB field)
   - Return { success: true } or { success: false, error: string }

3. `updateBillingAddress(formData: AddressInput)` action:
   - Same pattern as shipping address
   - Updates patients.billing_address field

All actions should:
- Use createClient() from @/lib/supabase/server
- Handle Supabase errors gracefully
- Return typed response { success: boolean, error?: string }
  </action>
  <verify>TypeScript compiles, actions export correctly</verify>
  <done>Three server actions exported: updateProfile, updateShippingAddress, updateBillingAddress</done>
</task>

<task type="auto">
  <name>Task 3: Create ProfileForm client component</name>
  <files>src/app/(dashboard)/patient/settings/profile-form.tsx</files>
  <action>
Create client component 'use client' with react-hook-form:

1. Props: `{ user: User, patient: Patient | null }`

2. Setup:
   - useForm with zodResolver(profileSchema)
   - Default values from user and patient props
   - isPending state for loading

3. Form fields:
   - First Name (required)
   - Last Name (required)
   - Phone (optional)
   - Date of Birth (optional)
   - Email (disabled, display only)

4. Submit handler:
   - Set isPending true
   - Call updateProfile server action
   - Show toast.success or toast.error based on result
   - Set isPending false

5. UI:
   - Use existing Card, Input, Label, Button from @/components/ui
   - Button shows "Saving..." when isPending
   - Button disabled when isPending

Import toast from 'sonner'.
  </action>
  <verify>Component renders without errors, form submits</verify>
  <done>ProfileForm component with validation and toast feedback</done>
</task>

<task type="auto">
  <name>Task 4: Create AddressForm client component</name>
  <files>src/app/(dashboard)/patient/settings/address-form.tsx</files>
  <action>
Create reusable client component for both shipping and billing:

1. Props:
   - type: 'shipping' | 'billing'
   - address: Address | null
   - title: string
   - description: string

2. Setup:
   - useForm with zodResolver(addressSchema)
   - Default values from address prop (or empty strings)
   - isPending state

3. Form fields:
   - Street Address (required)
   - City (required)
   - State (required, 2-letter code)
   - ZIP Code (required, 5 digits)

4. Submit handler:
   - Call updateShippingAddress or updateBillingAddress based on type prop
   - Show appropriate toast message
   - Distinguish between shipping and billing in toast ("Shipping address saved" vs "Billing address saved")

5. UI:
   - Card with CardHeader (title, description) and CardContent
   - Grid layout for city/state row
   - Same style as existing settings page
  </action>
  <verify>Component renders for both types, form submits</verify>
  <done>AddressForm component handles both shipping and billing addresses</done>
</task>

<task type="auto">
  <name>Task 5: Update settings page to use new components</name>
  <files>src/app/(dashboard)/patient/settings/page.tsx</files>
  <action>
Refactor the settings page:

1. Keep the existing async server component structure
2. Keep existing data fetching (user, patient)

3. Replace Profile tab content:
   - Remove inline form elements
   - Import and use ProfileForm component
   - Pass user and patient as props

4. Replace Addresses tab content:
   - Remove inline address forms
   - Import and use AddressForm component twice
   - One for shipping: type="shipping", address={patient?.shipping_address}
   - One for billing: type="billing", address={patient?.billing_address}

5. Keep Notifications and Security tabs as-is (will be implemented in later phases)
   - They can remain non-functional placeholder UI for now

6. Add Toaster component from sonner at page level if not already in layout
   - Check if Toaster is in root layout first
   - If not, add <Toaster /> to this page
  </action>
  <verify>npm run build succeeds, page renders with functional forms</verify>
  <done>Settings page uses ProfileForm and AddressForm components, forms work end-to-end</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Profile form saves changes to database (check Supabase)
- [ ] Shipping address form saves to patients.shipping_address
- [ ] Billing address form saves to patients.billing_address
- [ ] Toast messages appear on success and error
- [ ] Form validation shows errors for invalid input
- [ ] Loading state shows during save
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Patient can update profile and addresses
- Clear feedback via toast notifications
- Validation prevents invalid data
</success_criteria>

<output>
After completion, create `.planning/phases/07-profile-management/07-01-SUMMARY.md`
</output>
