---
phase: 17-treatment-plan-editor
plan: 04
type: execute
wave: 3
depends_on: ["17-03"]
files_modified:
  - src/lib/actions/treatment-plans.ts
  - src/components/provider/treatment-editor/send-plan-dialog.tsx
  - src/components/patient/treatment-plan-signoff.tsx
  - src/app/(dashboard)/patient/treatment-plan/signoff/page.tsx
  - src/types/database.ts
autonomous: false
---

<objective>
Implement patient sign-off workflow for treatment plans.

Purpose: After provider sends updated plan, patient must review and sign off before plan becomes fully active. This ensures patients are aware of their treatment protocols.
Output: Send plan dialog for providers, sign-off page for patients with confirmation workflow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-treatment-plan-editor/17-03-SUMMARY.md
@src/lib/actions/treatment-plans.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sign-off tracking to treatment plan actions</name>
  <files>src/lib/actions/treatment-plans.ts, src/types/database.ts</files>
  <action>
Extend treatment plan actions to support patient sign-off workflow.

**Update src/types/database.ts**:
- Add to TreatmentPlan interface:
  ```typescript
  sent_to_patient_at: string | null;
  patient_signed_off_at: string | null;
  ```

**Add to src/lib/actions/treatment-plans.ts**:

1. `sendPlanToPatient(treatmentPlanId: string)` - Provider sends plan to patient
   - Verify treatment plan exists and provider has access
   - Plan must be 'active' status
   - Update sent_to_patient_at timestamp
   - TODO: In future phase, this will trigger notification
   - Return success

2. `signOffTreatmentPlan(treatmentPlanId: string)` - Patient signs off
   - Verify user is patient and owns this treatment plan
   - Verify plan was sent (sent_to_patient_at not null)
   - Update patient_signed_off_at timestamp
   - Revalidate paths
   - Return success

3. `getPendingSignOff()` - Get treatment plan awaiting patient sign-off
   - For current patient user
   - Return treatment plan where sent_to_patient_at not null AND patient_signed_off_at is null
   - Include provider name for display
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>Sign-off tracking actions added with proper authorization</done>
</task>

<task type="auto">
  <name>Task 2: Create SendPlanDialog component</name>
  <files>src/components/provider/treatment-editor/send-plan-dialog.tsx</files>
  <action>
Create dialog for sending treatment plan to patient.

**SendPlanDialog**:
- Props: `treatmentPlanId: string`, `patientName: string`, `isOpen: boolean`, `onClose: () => void`
- UI:
  - AlertDialog with confirmation message
  - Title: "Send Treatment Plan"
  - Description: "This will send the updated treatment plan to {patientName}. The patient will need to review and sign off on the plan."
  - Warning: If plan not active, show message "Plan must be published before sending to patient"
  - Cancel and Confirm buttons

- Behavior:
  - On confirm: call sendPlanToPatient action
  - Show toast on success: "Treatment plan sent to {patientName}"
  - Close dialog
  - Disable confirm button while loading

Use shadcn/ui AlertDialog components.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>SendPlanDialog component created with confirmation flow</done>
</task>

<task type="auto">
  <name>Task 3: Create patient sign-off page</name>
  <files>src/components/patient/treatment-plan-signoff.tsx, src/app/(dashboard)/patient/treatment-plan/signoff/page.tsx</files>
  <action>
Create patient-facing sign-off flow.

**TreatmentPlanSignoff component** (`src/components/patient/treatment-plan-signoff.tsx`):
- Client component
- Props: `treatmentPlan: TreatmentPlan & { providers: { users: User } }`, `patientName: string`
- Display:
  - Card with "Review Your Treatment Plan"
  - Show provider name who sent it
  - Show sent date
  - Summary sections:
    - Prescriptions count with names listed
    - Peptides count with names listed
    - Supplements count with names listed
    - Checkmarks for lifestyle/nutrition/training if set
  - Link to view full treatment plan: "/patient/treatment-plan"
  - Checkbox: "I have reviewed and understand my treatment plan"
  - "Sign Off" button (disabled until checkbox checked)

- Behavior:
  - On sign off: call signOffTreatmentPlan action
  - Show toast on success
  - Redirect to /patient or show success message

**Page** (`src/app/(dashboard)/patient/treatment-plan/signoff/page.tsx`):
- Server component
- Fetch pending sign-off treatment plan using getPendingSignOff
- If no pending sign-off: show "No treatment plan awaiting review" with link back
- If pending: render TreatmentPlanSignoff component
- PageHeader: "Review Treatment Plan"
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>Patient sign-off page and component created</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete patient sign-off workflow for treatment plans</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Log in as provider
    3. Go to patient detail > Treatment Plan tab > Edit
    4. Make sure plan is published (active status)
    5. Click "Send to Patient" button
    6. Verify dialog appears, click confirm
    7. Log out and log in as patient
    8. Navigate to /patient/treatment-plan/signoff
    9. Verify: Plan summary displays
    10. Check the checkbox, click "Sign Off"
    11. Verify: Success message, redirects appropriately
    12. Verify: Revisiting signoff page shows "No treatment plan awaiting review"
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Provider can send plan to patient
- [ ] Patient can view pending sign-off
- [ ] Patient can sign off on plan
- [ ] Timestamps recorded correctly
</verification>

<success_criteria>
- All tasks completed
- Human verification passed
- Sign-off workflow works end-to-end
- Provider and patient flows complete
</success_criteria>

<output>
After completion, create `.planning/phases/17-treatment-plan-editor/17-04-SUMMARY.md`
</output>
