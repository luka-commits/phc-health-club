---
phase: 10-blood-work-upload
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/lib/actions/blood-work.ts
  - src/components/blood-work/BloodWorkUploadForm.tsx
  - src/app/(dashboard)/patient/blood-work/upload/page.tsx
autonomous: true
---

<objective>
Implement PDF upload functionality for blood work results using signed URLs.

Purpose: Enable patients to upload blood work PDF files securely, bypassing Next.js body size limits.
Output: Working upload page with drag-drop interface that stores PDFs in Supabase Storage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-blood-work-upload/10-RESEARCH.md
@.planning/phases/10-blood-work-upload/10-01-SUMMARY.md

@src/lib/supabase/server.ts
@src/lib/supabase/client.ts
@src/types/database.ts
@src/app/(dashboard)/patient/blood-work/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blood work server actions</name>
  <files>src/lib/actions/blood-work.ts</files>
  <action>
Create server actions file with:

1. `getBloodWorkUploadUrl(fileName: string)`:
   - Auth check with getUser()
   - Get patient ID from patients table via user_id
   - Generate unique path: `{patient_id}/{uuid}.{ext}`
   - Call supabase.storage.from('blood-work').createSignedUploadUrl(path)
   - Return { success: true, signedUrl, token, path } or { success: false, error }

2. `saveBloodWorkRecord(input: { pdfPath: string, date: string, labSource: string })`:
   - Auth check with getUser()
   - Get patient ID and verify ownership
   - Get public URL using getPublicUrl (for viewing, though bucket is private - use signed download URLs later if needed)
   - Insert into blood_work table with patient_id, date, lab_source, pdf_url
   - revalidatePath('/patient/blood-work')
   - Return { success: true } or { success: false, error }

Use 'use server' directive. Follow project pattern for server action return types.
Import uuid with: import { v4 as uuidv4 } from 'uuid'
  </action>
  <verify>TypeScript compiles: cd phc-health-club && npx tsc --noEmit</verify>
  <done>Both server actions exported and type-safe</done>
</task>

<task type="auto">
  <name>Task 2: Create BloodWorkUploadForm component</name>
  <files>src/components/blood-work/BloodWorkUploadForm.tsx</files>
  <action>
Create client component with:

1. 'use client' directive
2. Props: patientId: string
3. State: uploading, error, success
4. useDropzone hook from react-dropzone with:
   - accept: { 'application/pdf': ['.pdf'] }
   - maxSize: 10 * 1024 * 1024 (10MB)
   - maxFiles: 1
   - disabled: uploading

5. onDrop handler:
   - Get signed URL via getBloodWorkUploadUrl(file.name)
   - Upload to Supabase using client: supabase.storage.from('blood-work').uploadToSignedUrl(path, token, file)
   - Save record via saveBloodWorkRecord with today's date, 'other' as default lab
   - Show success state or error

6. UI:
   - Dropzone area with border-dashed, hover states
   - Show uploading spinner when in progress
   - Show success message with link back to blood work page
   - Show error message if failed

Use Tailwind for styling. Import server actions from '@/lib/actions/blood-work'.
  </action>
  <verify>TypeScript compiles: cd phc-health-club && npx tsc --noEmit</verify>
  <done>BloodWorkUploadForm renders with drag-drop zone and handles upload flow</done>
</task>

<task type="auto">
  <name>Task 3: Create upload page</name>
  <files>src/app/(dashboard)/patient/blood-work/upload/page.tsx</files>
  <action>
Create server component page:

1. Auth check with getDBUser(), redirect if not authenticated or not patient
2. Get patient record from patients table
3. Render:
   - PageHeader with title "Upload Blood Work" and back link
   - Card containing BloodWorkUploadForm component with patientId prop
   - Instructions text explaining supported formats (PDF) and size limit (10MB)
   - Later section placeholder for manual entry (Phase 10-03)

Use existing components: PageHeader, Card, CardHeader, CardContent, Button.
Follow existing page patterns from blood-work/page.tsx.
  </action>
  <verify>
cd phc-health-club && npm run build
Verify page compiles and route exists
  </verify>
  <done>Upload page accessible at /patient/blood-work/upload with working form</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] TypeScript compiles without errors
- [ ] Upload page renders at /patient/blood-work/upload
- [ ] Dropzone accepts PDF files only
- [ ] Server actions are properly typed
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PDF upload flow works end-to-end (pending Supabase bucket setup in production)
- Upload page accessible from blood work list page
</success_criteria>

<output>
After completion, create `.planning/phases/10-blood-work-upload/10-02-SUMMARY.md`
</output>
