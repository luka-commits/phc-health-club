---
phase: 17-treatment-plan-editor
plan: 03
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified:
  - src/app/(dashboard)/provider/patients/[id]/treatment-plan/page.tsx
  - src/components/provider/treatment-editor/treatment-plan-editor.tsx
  - src/components/provider/patient-detail/treatment-plan-tab.tsx
autonomous: false
---

<objective>
Create treatment plan editor page with tabbed interface, auto-save, and publish workflow.

Purpose: Provide providers with a comprehensive editor to manage all treatment plan sections, save drafts, and publish to patients.
Output: Treatment plan editor page accessible from patient detail view with full editing capabilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-treatment-plan-editor/17-01-SUMMARY.md
@.planning/phases/17-treatment-plan-editor/17-02-SUMMARY.md
@src/app/(dashboard)/provider/patients/[id]/page.tsx
@src/lib/actions/treatment-plans.ts
@src/types/treatment-plan.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TreatmentPlanEditor component</name>
  <files>src/components/provider/treatment-editor/treatment-plan-editor.tsx</files>
  <action>
Create client component that orchestrates all 6 section editors.

**TreatmentPlanEditor**:
- Props: `treatmentPlan: TreatmentPlan`, `patientId: string`, `patientName: string`
- State:
  - `formData: TreatmentPlanData` - current editor state
  - `isDirty: boolean` - tracks unsaved changes
  - `isSaving: boolean` - loading state
  - `activeTab: string` - current section tab

- UI Structure:
  - Header with patient name, status badge (draft/active), last saved timestamp
  - Tabs component with 6 tabs: Lifestyle, Nutrition, Training, Prescriptions, Peptides, Supplements
  - Each tab renders corresponding editor component
  - Footer with:
    - "Save Draft" button (always visible for draft plans)
    - "Publish Plan" button (changes status to active, shows confirmation)
    - "Send to Patient" button (triggers notification to patient)

- Behavior:
  - Initialize formData from treatmentPlan props
  - Pass section data and onChange to each editor
  - onChange updates formData and sets isDirty=true
  - Save Draft: calls updateTreatmentPlan action, sets isDirty=false
  - Publish Plan: calls updateTreatmentPlanStatus with 'active'
  - Show toast notifications for save success/error
  - Warn before leaving page with unsaved changes (optional: use beforeunload)

- Use shadcn/ui: Tabs, TabsList, TabsTrigger, TabsContent, Button, Badge, Card
- Use sonner for toast notifications
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>TreatmentPlanEditor component with tabbed interface and save functionality</done>
</task>

<task type="auto">
  <name>Task 2: Create treatment plan editor page</name>
  <files>src/app/(dashboard)/provider/patients/[id]/treatment-plan/page.tsx</files>
  <action>
Create server component page for editing treatment plan.

**Page route:** `/provider/patients/[id]/treatment-plan`

- Server component that:
  - Authenticates user (redirect if not provider/admin)
  - Fetches patient data (name for display)
  - Fetches existing treatment plan for patient
  - If no treatment plan exists: create one with createTreatmentPlan action
  - Renders TreatmentPlanEditor with fetched data

- Header:
  - Back arrow linking to `/provider/patients/[id]`
  - PageHeader with "Edit Treatment Plan - {Patient Name}"

- Authorization:
  - MD/Admin can edit any patient's plan
  - PA/NP can edit plans they created
  - Redirect to patient list if unauthorized

Use same patterns as patient detail page for data fetching and authorization.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>Treatment plan editor page accessible at /provider/patients/[id]/treatment-plan</done>
</task>

<task type="auto">
  <name>Task 3: Add Edit button to TreatmentPlanTab</name>
  <files>src/components/provider/patient-detail/treatment-plan-tab.tsx</files>
  <action>
Update TreatmentPlanTab to include Edit button linking to editor.

- Add prop: `patientId: string` to TreatmentPlanTabProps
- Add "Edit Treatment Plan" button in header (next to status badge)
- Button links to `/provider/patients/${patientId}/treatment-plan`
- Use shadcn/ui Button with Edit2 icon from lucide-react
- Style as secondary variant

If no treatment plan exists (empty state), change button text to "Create Treatment Plan".
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>Edit/Create button added to treatment plan tab</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Treatment plan editor with full editing capabilities for all 6 sections</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Log in as provider user
    3. Go to /provider/patients
    4. Click on any patient to view detail
    5. Go to Treatment Plan tab
    6. Click "Edit Treatment Plan" button
    7. Verify: Editor page loads with 6 tabs
    8. Make changes to any section
    9. Click "Save Draft" - verify toast success
    10. Navigate away and back - verify changes persisted
    11. Test "Publish Plan" button - verify status changes to active
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Editor page loads correctly
- [ ] All 6 section tabs work
- [ ] Save draft functionality works
- [ ] Publish workflow changes status
- [ ] Edit button visible in patient detail view
</verification>

<success_criteria>
- All tasks completed
- Human verification passed
- Treatment plan editor fully functional
- Draft/publish workflow working
</success_criteria>

<output>
After completion, create `.planning/phases/17-treatment-plan-editor/17-03-SUMMARY.md`
</output>
