---
phase: 15-patient-list
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/provider/patients/page.tsx
  - src/components/provider/patient-list.tsx
autonomous: true
---

<objective>
Enhance the provider patients page with client-side search, sorting, pagination, and role-based visibility.

Purpose: Enable providers to efficiently find and manage their patients with search by name, sort options (alphabetical/newest/oldest), and ensure MD/Admin see ALL patients while PA/NP see only their assigned patients.
Output: Fully functional patient list with search, filter, sort, and pagination capabilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns to follow:
@src/app/(dashboard)/patient/products/page.tsx - Client-side search with debounce pattern
@src/app/(dashboard)/provider/patients/page.tsx - Current provider patients page structure
@src/app/(dashboard)/provider/page.tsx - Provider dashboard with role checks and Supabase queries
@src/types/database.ts - Provider, Patient, User types with ProviderLicenseType
@src/lib/supabase/auth.ts - getDBUser pattern for role checks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PatientList client component with search, sort, and pagination</name>
  <files>src/components/provider/patient-list.tsx</files>
  <action>
Create a client component that receives patients data as props and implements:

1. **State management:**
   - `searchQuery` and `debouncedQuery` (300ms debounce) for search
   - `sortOrder` state: 'alphabetical' | 'newest' | 'oldest' (default: 'alphabetical')
   - `currentPage` state for pagination (default: 1)
   - `ITEMS_PER_PAGE` constant (10)

2. **Search functionality:**
   - Input field with Search icon (from lucide-react)
   - Filter by patient's first_name OR last_name (case-insensitive)
   - Use existing debounce pattern from products page

3. **Sort functionality:**
   - Dropdown or toggle buttons for sort order
   - 'alphabetical': sort by last_name, then first_name
   - 'newest': sort by lastUpdated descending
   - 'oldest': sort by lastUpdated ascending

4. **Pagination:**
   - Calculate total pages from filtered/sorted results
   - Slice results for current page
   - Previous/Next buttons with disabled states
   - Page indicator (e.g., "Page 1 of 5")

5. **UI structure (from existing patterns):**
   - PageHeader with dynamic patient count
   - Search input with icon
   - Sort controls (use Select or Button group)
   - Patient cards in a grid (existing Card pattern)
   - Empty state when no patients or no search results
   - Pagination controls at bottom

Follow the exact patterns from products/page.tsx for debounce and filtering logic.
Use shadcn/ui Select component for sort dropdown.
  </action>
  <verify>TypeScript compilation succeeds: cd /Users/lukaknieling/Desktop/Custom\ software/phc-health-club && npm run build 2>&1 | head -50</verify>
  <done>PatientList component exists with search, sort, and pagination functionality</done>
</task>

<task type="auto">
  <name>Task 2: Refactor patients page for role-based visibility and data fetching</name>
  <files>src/app/(dashboard)/provider/patients/page.tsx</files>
  <action>
Refactor the existing patients page to:

1. **Role-based data fetching:**
   - Get provider record with license_type
   - If license_type is 'MD' OR user role is 'admin': fetch ALL patients (no provider filter)
   - If license_type is 'PA' or 'NP': fetch only assigned patients via treatment_plans (current behavior)

2. **Query structure for MD/Admin (all patients):**
```typescript
const { data: allPatients } = await supabase
  .from('patients')
  .select(`
    id,
    intake_completed,
    created_at,
    users(first_name, last_name, email, avatar_url, phone)
  `)
  .order('created_at', { ascending: false });
```

3. **Keep existing query for PA/NP** (assigned patients via treatment_plans)

4. **Transform data to common format:**
   - id, first_name, last_name, email, avatar_url, phone
   - intake_completed
   - treatmentPlanStatus (or 'N/A' for MD viewing unassigned patients)
   - lastUpdated (from treatment_plan.updated_at or patient.created_at)

5. **Pass data to PatientList component:**
   - Import and render PatientList client component
   - Pass transformed patients array as prop
   - Pass showAllPatients boolean (for UI messaging)

6. **Update page header:**
   - For MD/Admin: "All Patients" with total count
   - For PA/NP: "My Patients" with assigned count

The server component handles auth, role checks, and data fetching.
The client component (PatientList) handles search, sort, pagination.
  </action>
  <verify>Start dev server and verify page loads: cd /Users/lukaknieling/Desktop/Custom\ software/phc-health-club && npm run dev & sleep 5 && curl -s http://localhost:3000 | head -20 && pkill -f "next dev"</verify>
  <done>Patients page fetches data based on role and passes to PatientList component</done>
</task>

<task type="auto">
  <name>Task 3: Add type definitions and ensure build passes</name>
  <files>src/components/provider/patient-list.tsx, src/app/(dashboard)/provider/patients/page.tsx</files>
  <action>
1. **Define PatientListItem type** (in patient-list.tsx or separate types file):
```typescript
interface PatientListItem {
  id: string;
  firstName: string;
  lastName: string;
  email: string;
  avatarUrl: string | null;
  phone: string | null;
  intakeCompleted: boolean;
  treatmentPlanStatus: string | null;
  lastUpdated: string;
}
```

2. **Define PatientListProps:**
```typescript
interface PatientListProps {
  patients: PatientListItem[];
  showAllPatients: boolean;
}
```

3. **Ensure proper exports** and imports between components

4. **Run full build** to catch any TypeScript errors

5. **Fix any type issues** that arise from the refactor
  </action>
  <verify>Full build passes: cd /Users/lukaknieling/Desktop/Custom\ software/phc-health-club && npm run build</verify>
  <done>All types defined, build passes with no errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] PatientList component implements search with 300ms debounce
- [ ] Sort options work (alphabetical, newest, oldest)
- [ ] Pagination shows correct page count and navigates correctly
- [ ] MD/Admin role sees all patients header
- [ ] PA/NP role sees assigned patients header
- [ ] Empty state displays when no results match search
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Search filters patients by name in real-time
- Sort orders patients correctly by all three options
- Pagination limits display to 10 patients per page
- Role-based visibility implemented correctly
</success_criteria>

<output>
After completion, create `.planning/phases/15-patient-list/15-01-SUMMARY.md`
</output>
