---
phase: 10-blood-work-upload
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - src/lib/validations/blood-work.ts
  - src/lib/actions/blood-work.ts
  - src/components/blood-work/ManualEntryForm.tsx
  - src/app/(dashboard)/patient/blood-work/upload/page.tsx
autonomous: true
---

<objective>
Implement manual biomarker entry functionality for blood work results.

Purpose: Enable patients to manually enter biomarker values when they don't have a PDF or want to add specific values.
Output: Working manual entry form integrated into the upload page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-blood-work-upload/10-RESEARCH.md
@.planning/phases/10-blood-work-upload/10-02-SUMMARY.md

@src/types/database.ts
@src/lib/actions/blood-work.ts
@src/app/(dashboard)/patient/blood-work/upload/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blood work validation schema</name>
  <files>src/lib/validations/blood-work.ts</files>
  <action>
Create Zod validation schemas:

1. `biomarkerSchema`:
   - name: z.string().min(1) - biomarker name (e.g., "Testosterone", "TSH")
   - value: z.number().positive() - the measured value
   - unit: z.string().min(1) - unit of measurement (e.g., "ng/dL", "mIU/L")
   - reference_low: z.number().nullable().optional() - low end of reference range
   - reference_high: z.number().nullable().optional() - high end of reference range

2. `manualEntrySchema`:
   - date: z.string() - date of blood work (ISO format)
   - lab_source: z.enum(['quest', 'labcorp', 'other'])
   - notes: z.string().optional()
   - biomarkers: z.array(biomarkerSchema).min(1) - at least one biomarker required

Export schemas and inferred types.
  </action>
  <verify>TypeScript compiles: cd phc-health-club && npx tsc --noEmit</verify>
  <done>Schemas exported and types inferred correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add manual entry server action</name>
  <files>src/lib/actions/blood-work.ts</files>
  <action>
Add new server action to existing file:

`saveManualBloodWork(input: ManualEntryInput)`:
1. Auth check with getUser()
2. Get patient ID and verify ownership
3. Validate input with manualEntrySchema
4. Transform biomarkers array to Record<string, BiomarkerValue> format:
   - Key = biomarker name
   - Value = { value, unit, reference_low, reference_high, flag }
   - Calculate flag based on value vs reference range (low/normal/high/null)
5. Insert into blood_work table:
   - patient_id, date, lab_source, notes
   - biomarkers (the transformed Record)
   - pdf_url: null (no PDF for manual entry)
6. revalidatePath('/patient/blood-work')
7. Return { success: true } or { success: false, error }

Import ManualEntryInput type from validations/blood-work.ts.
  </action>
  <verify>TypeScript compiles: cd phc-health-club && npx tsc --noEmit</verify>
  <done>saveManualBloodWork action exported and handles biomarker transformation</done>
</task>

<task type="auto">
  <name>Task 3: Create ManualEntryForm component</name>
  <files>src/components/blood-work/ManualEntryForm.tsx</files>
  <action>
Create client component with:

1. 'use client' directive
2. Props: patientId: string
3. Use react-hook-form with zodResolver for manualEntrySchema
4. Dynamic biomarker fields using useFieldArray:
   - Add/remove biomarker rows
   - Each row: name input, value number input, unit input
   - Optional: reference_low and reference_high (collapsible "Add reference range")

5. Form structure:
   - Date picker (use native date input for simplicity)
   - Lab source select (Quest, LabCorp, Other)
   - Biomarkers section with dynamic rows
   - Add Biomarker button
   - Notes textarea (optional)
   - Submit button

6. onSubmit: call saveManualBloodWork, show success/error toast

Use shadcn/ui components: Input, Select, Button, Label, Textarea.
Use Sonner for toast notifications (already in project from Phase 7).
  </action>
  <verify>TypeScript compiles: cd phc-health-club && npx tsc --noEmit</verify>
  <done>ManualEntryForm renders with dynamic biomarker fields and form validation</done>
</task>

<task type="auto">
  <name>Task 4: Integrate manual entry into upload page</name>
  <files>src/app/(dashboard)/patient/blood-work/upload/page.tsx</files>
  <action>
Update upload page to include manual entry:

1. Add Tabs component to switch between "Upload PDF" and "Manual Entry"
2. Tab 1: BloodWorkUploadForm (existing)
3. Tab 2: ManualEntryForm (new)

Structure:
```
<Tabs defaultValue="upload">
  <TabsList>
    <TabsTrigger value="upload">Upload PDF</TabsTrigger>
    <TabsTrigger value="manual">Manual Entry</TabsTrigger>
  </TabsList>
  <TabsContent value="upload">
    <BloodWorkUploadForm patientId={patient.id} />
  </TabsContent>
  <TabsContent value="manual">
    <ManualEntryForm patientId={patient.id} />
  </TabsContent>
</Tabs>
```

Use shadcn/ui Tabs components.
  </action>
  <verify>cd phc-health-club && npm run build</verify>
  <done>Upload page shows tabs for PDF upload and manual entry</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] TypeScript compiles without errors
- [ ] Upload page shows two tabs: Upload PDF and Manual Entry
- [ ] Manual entry form validates biomarker inputs
- [ ] Dynamic add/remove for biomarker rows works
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Manual entry form accepts biomarker data
- Both upload methods available on same page
- Form validation works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/10-blood-work-upload/10-03-SUMMARY.md`
</output>
