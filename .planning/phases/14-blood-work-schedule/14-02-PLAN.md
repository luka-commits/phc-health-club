---
phase: 14-blood-work-schedule
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - supabase/migrations/002_blood_work_requests.sql
  - src/types/database.ts
  - src/lib/actions/blood-work-requests.ts
  - src/components/blood-work/request-blood-work-dialog.tsx
  - src/app/(dashboard)/patient/blood-work-schedule/page.tsx
autonomous: false
---

<objective>
Add blood work request functionality so patients can request additional lab work.

Purpose: Patients can request extra blood work on specific dates, which their provider can then review and approve. This enables patient-initiated lab scheduling outside the regular schedule.

Output: Working blood work request form integrated into the schedule page, with requests visible to providers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-blood-work-schedule/14-01-SUMMARY.md

@src/app/(dashboard)/patient/blood-work-schedule/page.tsx
@src/types/database.ts
@src/lib/actions/lifestyle-notes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blood work requests database table</name>
  <files>supabase/migrations/002_blood_work_requests.sql</files>
  <action>
Create migration for blood_work_requests table.

**Schema:**
```sql
-- Blood work requests from patients
CREATE TABLE IF NOT EXISTS blood_work_requests (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  requested_date DATE NOT NULL,
  reason TEXT,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'denied', 'completed')),
  provider_notes TEXT,
  reviewed_by UUID REFERENCES providers(id),
  reviewed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for efficient queries
CREATE INDEX idx_blood_work_requests_patient ON blood_work_requests(patient_id);
CREATE INDEX idx_blood_work_requests_status ON blood_work_requests(status);

-- RLS policies
ALTER TABLE blood_work_requests ENABLE ROW LEVEL SECURITY;

-- Patients can view their own requests
CREATE POLICY "Patients can view own blood work requests"
  ON blood_work_requests FOR SELECT
  TO authenticated
  USING (
    patient_id IN (
      SELECT id FROM patients WHERE user_id = auth.uid()
    )
  );

-- Patients can create requests
CREATE POLICY "Patients can create blood work requests"
  ON blood_work_requests FOR INSERT
  TO authenticated
  WITH CHECK (
    patient_id IN (
      SELECT id FROM patients WHERE user_id = auth.uid()
    )
  );

-- Providers can view all requests (for their patients via treatment_plans)
CREATE POLICY "Providers can view blood work requests"
  ON blood_work_requests FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM providers p
      WHERE p.user_id = auth.uid()
    )
  );

-- Providers can update requests (approve/deny)
CREATE POLICY "Providers can update blood work requests"
  ON blood_work_requests FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM providers p
      WHERE p.user_id = auth.uid()
    )
  );

-- Updated_at trigger
CREATE OR REPLACE FUNCTION update_blood_work_requests_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER blood_work_requests_updated_at
  BEFORE UPDATE ON blood_work_requests
  FOR EACH ROW
  EXECUTE FUNCTION update_blood_work_requests_updated_at();
```

**DO NOT:**
- Use incorrect column types
- Forget RLS policies (HIPAA compliance)
- Forget indexes for common queries
  </action>
  <verify>Run migration: `cd phc-health-club && npx supabase db push` or verify SQL syntax</verify>
  <done>blood_work_requests table created with RLS policies</done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript types and server action</name>
  <files>src/types/database.ts, src/lib/actions/blood-work-requests.ts</files>
  <action>
Add BloodWorkRequest type and create server action for requests.

**In src/types/database.ts, add:**
```typescript
export type BloodWorkRequestStatus = 'pending' | 'approved' | 'denied' | 'completed';

export interface BloodWorkRequest {
  id: string;
  patient_id: string;
  requested_date: string;
  reason: string | null;
  status: BloodWorkRequestStatus;
  provider_notes: string | null;
  reviewed_by: string | null;
  reviewed_at: string | null;
  created_at: string;
  updated_at: string;
}
```

**Create src/lib/actions/blood-work-requests.ts:**
```typescript
'use server'

import { createClient } from '@/lib/supabase/server';
import { getDBUser } from '@/lib/supabase/auth';
import { revalidatePath } from 'next/cache';

interface CreateBloodWorkRequestInput {
  requested_date: string;
  reason?: string;
}

export async function createBloodWorkRequest(input: CreateBloodWorkRequestInput) {
  const { user, error: authError } = await getDBUser();

  if (authError || !user || user.role !== 'patient') {
    return { success: false, error: 'Unauthorized' };
  }

  const supabase = await createClient();

  // Get patient ID
  const { data: patient } = await supabase
    .from('patients')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!patient) {
    return { success: false, error: 'Patient not found' };
  }

  // Create request
  const { error } = await supabase
    .from('blood_work_requests')
    .insert({
      patient_id: patient.id,
      requested_date: input.requested_date,
      reason: input.reason || null,
      status: 'pending',
    });

  if (error) {
    return { success: false, error: error.message };
  }

  revalidatePath('/patient/blood-work-schedule');
  return { success: true };
}

export async function getBloodWorkRequests() {
  const { user, error: authError } = await getDBUser();

  if (authError || !user) {
    return { success: false, error: 'Unauthorized', data: null };
  }

  const supabase = await createClient();

  // Get patient ID
  const { data: patient } = await supabase
    .from('patients')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!patient) {
    return { success: false, error: 'Patient not found', data: null };
  }

  const { data, error } = await supabase
    .from('blood_work_requests')
    .select('*')
    .eq('patient_id', patient.id)
    .order('requested_date', { ascending: true });

  if (error) {
    return { success: false, error: error.message, data: null };
  }

  return { success: true, data };
}
```

Follow existing server action patterns (return { success: true } | { success: false, error: string }).
  </action>
  <verify>TypeScript compiles: `cd phc-health-club && npx tsc --noEmit`</verify>
  <done>BloodWorkRequest type added and server actions created</done>
</task>

<task type="auto">
  <name>Task 3: Create request blood work dialog component</name>
  <files>src/components/blood-work/request-blood-work-dialog.tsx</files>
  <action>
Create a dialog component for patients to request additional blood work.

**Implementation:**
1. Mark as 'use client'
2. Use Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogTrigger, DialogFooter from shadcn/ui
3. Use Calendar from @/components/ui/calendar for date selection
4. Use Textarea for optional reason
5. Use Button with loading state
6. Use Form with react-hook-form and zodResolver

**Component structure:**
```typescript
'use client'

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { format } from 'date-fns';
import { Calendar as CalendarIcon, Plus } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Calendar } from '@/components/ui/calendar';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Textarea } from '@/components/ui/textarea';
import { cn } from '@/lib/utils';
import { createBloodWorkRequest } from '@/lib/actions/blood-work-requests';

const formSchema = z.object({
  requested_date: z.date({
    required_error: 'Please select a date',
  }),
  reason: z.string().max(500).optional(),
});

export function RequestBloodWorkDialog() {
  const [open, setOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      reason: '',
    },
  });

  async function onSubmit(values: z.infer<typeof formSchema>) {
    setIsSubmitting(true);
    const result = await createBloodWorkRequest({
      requested_date: format(values.requested_date, 'yyyy-MM-dd'),
      reason: values.reason,
    });
    setIsSubmitting(false);

    if (result.success) {
      setOpen(false);
      form.reset();
    }
  }

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button>
          <Plus className="mr-2 h-4 w-4" />
          Request Lab Work
        </Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Request Additional Blood Work</DialogTitle>
          <DialogDescription>
            Select a date when you'd like to have your labs done. Your provider will review and approve the request.
          </DialogDescription>
        </DialogHeader>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            {/* Date picker with Popover + Calendar */}
            {/* Reason textarea */}
            <DialogFooter>
              <Button type="submit" disabled={isSubmitting}>
                {isSubmitting ? 'Submitting...' : 'Submit Request'}
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

**Date picker:** Use Popover with Calendar inside, format selected date, disable past dates.

**DO NOT:**
- Allow selecting past dates
- Forget loading state during submission
- Forget form validation
  </action>
  <verify>TypeScript compiles: `cd phc-health-club && npx tsc --noEmit`</verify>
  <done>RequestBloodWorkDialog component created with date picker and reason field</done>
</task>

<task type="auto">
  <name>Task 4: Integrate request dialog and display requests on schedule page</name>
  <files>src/app/(dashboard)/patient/blood-work-schedule/page.tsx</files>
  <action>
Update the schedule page to include the request dialog and show pending requests.

**Changes:**
1. Import RequestBloodWorkDialog component
2. Add RequestBloodWorkDialog button next to the PageHeader
3. Fetch blood_work_requests alongside appointments and blood_work
4. Transform requests to calendar events (type: 'requested', color: blue/purple)
5. In list view, add section for "Your Requests" showing pending/approved/denied requests with status badges
6. Update BloodWorkCalendar events to include requests

**Request status display:**
- pending: yellow badge "Pending Review"
- approved: green badge "Approved"
- denied: red badge "Denied" with provider_notes if available
- completed: gray badge "Completed"

**Calendar event colors:**
- scheduled (appointments): orange
- completed (blood_work): green
- requested (requests): blue (hsl(221 83% 53%))

**List view sections:**
1. "Upcoming Blood Work" - scheduled appointments
2. "Your Requests" - blood_work_requests with status
3. "Completed Labs" - past blood_work records with links

**DO NOT:**
- Remove existing functionality
- Forget to fetch requests data
- Make the page too cluttered (use collapsible sections if needed)
  </action>
  <verify>
1. `cd phc-health-club && npm run build` succeeds
2. No TypeScript errors
  </verify>
  <done>Schedule page shows request button, pending requests, and requests on calendar</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Blood work request functionality with dialog form and display of requests on schedule page</what-built>
  <how-to-verify>
    1. Run: cd phc-health-club && npm run dev
    2. Run migration if not done: cd phc-health-club && npx supabase db push
    3. Login as a patient
    4. Navigate to: http://localhost:3000/patient/blood-work-schedule
    5. Verify: "Request Lab Work" button visible in header area
    6. Click "Request Lab Work" button:
       - Dialog opens with date picker and reason field
       - Cannot select past dates
       - Submit with a future date
    7. After submission:
       - Dialog closes
       - Request appears in "Your Requests" section with "Pending Review" badge
       - Request appears on calendar (blue color)
    8. Test calendar view: Request event shows on selected date
    9. No console errors in browser DevTools
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration runs without errors
- [ ] `npm run build` succeeds
- [ ] No TypeScript errors
- [ ] Request dialog opens and submits
- [ ] Requests appear in list view with status
- [ ] Requests appear on calendar
- [ ] RLS policies work correctly
</verification>

<success_criteria>
- All tasks completed
- Patients can request blood work via dialog
- Requests stored in database with RLS
- Requests visible in list and calendar views
- Status badges display correctly
- Visual verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/14-blood-work-schedule/14-02-SUMMARY.md`
</output>
