---
phase: 17-treatment-plan-editor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/actions/treatment-plans.ts
  - src/types/treatment-plan.ts
autonomous: true
---

<objective>
Create server actions for treatment plan CRUD operations with provider authorization.

Purpose: Enable providers to create, update, and manage treatment plans for patients with proper validation and authorization checks.
Output: Server actions for treatment plan management supporting draft/publish workflow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/database.ts
@src/types/treatment-plan.ts
@src/lib/actions/patients.ts
@src/lib/supabase/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create treatment plan server actions</name>
  <files>src/lib/actions/treatment-plans.ts</files>
  <action>
Create server actions file with the following functions:

1. `createTreatmentPlan(patientId: string)` - Create new draft treatment plan
   - Verify provider authorization (MD can create for any, PA/NP only for assigned patients)
   - Create with status='draft', empty JSONB sections, provider_id from current user
   - Return new treatment plan ID

2. `updateTreatmentPlan(input: TreatmentPlanUpdateInput)` - Update treatment plan sections
   - Input includes: treatmentPlanId, optional section data (lifestyle_behaviors, nutrition, training, prescriptions_data, peptides_data, supplements_data, notes)
   - Verify provider owns this treatment plan or is MD/admin
   - Update only provided sections (partial update)
   - Set updated_at timestamp

3. `updateTreatmentPlanStatus(treatmentPlanId: string, status: 'draft' | 'active' | 'completed')` - Change status
   - Verify provider authorization
   - When changing to 'active': validates required sections are filled
   - Returns success/error

4. `deleteTreatmentPlan(treatmentPlanId: string)` - Delete draft treatment plan
   - Only allow deletion of draft plans
   - Verify provider authorization

Use Zod for validation. Follow established patterns from patients.ts:
- ActionResult type: { success: true } | { success: false, error: string }
- getDBUser() for auth
- createClient() for Supabase
- revalidatePath() after mutations
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit</verify>
  <done>All 4 server actions created with proper authorization and validation</done>
</task>

<task type="auto">
  <name>Task 2: Add TreatmentPlanUpdateInput type</name>
  <files>src/types/treatment-plan.ts</files>
  <action>
Add input type at the end of the file for treatment plan updates:

```typescript
// ============================================
// Update Input Type (for server actions)
// ============================================

export interface TreatmentPlanUpdateInput {
  treatmentPlanId: string;
  lifestyle_behaviors?: LifestyleData | null;
  nutrition?: NutritionData | null;
  training?: TrainingData | null;
  prescriptions_data?: PrescriptionItem[] | null;
  peptides_data?: PeptideItem[] | null;
  supplements_data?: SupplementItem[] | null;
  notes?: string | null;
}
```

This type enables partial updates - only provided fields are updated.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>TreatmentPlanUpdateInput type exported and usable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] All 4 server actions export correctly
- [ ] TypeScript types are consistent
- [ ] Authorization checks present in all actions
</verification>

<success_criteria>
- All tasks completed
- Server actions for CRUD operations working
- Proper provider authorization implemented
- Draft/active/completed status workflow supported
</success_criteria>

<output>
After completion, create `.planning/phases/17-treatment-plan-editor/17-01-SUMMARY.md`
</output>
