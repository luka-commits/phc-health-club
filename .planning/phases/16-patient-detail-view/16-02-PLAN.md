---
phase: 16-patient-detail-view
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/app/(dashboard)/provider/patients/[id]/page.tsx
  - src/components/provider/patient-detail/treatment-plan-tab.tsx
  - src/components/provider/patient-detail/prescriptions-list.tsx
autonomous: true
---

<objective>
Add Treatment Plan tab with summary view and prescriptions list.

Purpose: Provider can see patient's treatment plan summary and all active prescriptions from the detail page.
Output: Treatment Plan tab displays plan overview and medications/prescriptions organized by type.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context
@.planning/phases/16-patient-detail-view/16-01-SUMMARY.md

# Existing treatment plan patterns
@src/app/(dashboard)/patient/treatment-plan/page.tsx
@src/components/treatment-plan/prescriptions-section.tsx
@src/components/treatment-plan/peptides-section.tsx
@src/components/treatment-plan/supplements-section.tsx
@src/types/treatment-plan.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TreatmentPlanTab component</name>
  <files>src/components/provider/patient-detail/treatment-plan-tab.tsx</files>
  <action>
Create component that displays treatment plan summary for a patient:

1. Props: treatmentPlan (full treatment plan object or null)

2. If no treatment plan:
   - Show EmptyState with FileText icon
   - "No Active Treatment Plan" message
   - Description: "Create a treatment plan for this patient."
   - (Later phases will add "Create Plan" button)

3. If treatment plan exists, show:
   a. Overview Card:
      - Status badge (active/draft/completed)
      - Provider name (from joined providers.users)
      - Created date, last updated date
      - Notes preview (first 200 chars with "..." if longer)

   b. Medications Summary (collapsible sections):
      - Prescriptions count badge + collapsed list
      - Peptides count badge + collapsed list
      - Supplements count badge + collapsed list

   c. Lifestyle Summary (brief):
      - Show if lifestyle_behaviors, nutrition, training data exists
      - Display as checkmarks: "Lifestyle guidelines set", "Nutrition plan set", etc.

Use Collapsible from shadcn/ui for expandable sections.
Reuse existing MedicationItem component for displaying items.
  </action>
  <verify>Component renders treatment plan summary correctly, handles empty state</verify>
  <done>TreatmentPlanTab shows plan overview with collapsible medication sections</done>
</task>

<task type="auto">
  <name>Task 2: Create PrescriptionsList component</name>
  <files>src/components/provider/patient-detail/prescriptions-list.tsx</files>
  <action>
Create component showing all prescriptions for a patient (from prescriptions table, not just treatment plan data):

1. Props: patientId: string

2. Fetch prescriptions from prescriptions table:
   - Join with products table for product details
   - Filter by patient_id
   - Order by created_at desc

3. Display as table (for provider view - more data than patient sees):
   - Medication name (product.name)
   - Type badge (rx/peptide/supplement)
   - Dosage
   - Quantity
   - Instructions (truncated)
   - Pharmacy
   - Next refill date
   - Status badge (active/paused/completed/cancelled)
   - Auto-refill indicator

4. Empty state if no prescriptions

Use Table component from shadcn/ui.
This shows actual prescription records, not just treatment plan snapshot.
  </action>
  <verify>PrescriptionsList fetches and displays prescriptions in table format</verify>
  <done>Provider sees complete prescription history with all details</done>
</task>

<task type="auto">
  <name>Task 3: Integrate components into detail page</name>
  <files>src/app/(dashboard)/provider/patients/[id]/page.tsx</files>
  <action>
Update the patient detail page to:

1. Fetch treatment plan data in server component:
   - Query treatment_plans for this patient
   - Include provider join (providers.users for name)
   - Get active plan or most recent if no active

2. Fetch prescriptions data:
   - Query prescriptions with product join
   - Filter by patient_id

3. Update "Treatment Plan" TabsContent:
   - Add TreatmentPlanTab component with treatment plan data
   - Add PrescriptionsList below treatment plan summary
   - Wrap in appropriate spacing

4. Remove placeholder text from Treatment Plan tab

Pass data as props (server-fetched, not client-fetched) for performance.
  </action>
  <verify>Treatment Plan tab shows full content, data loads correctly</verify>
  <done>Treatment Plan tab fully functional with plan summary and prescriptions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Treatment Plan tab shows plan summary
- [ ] Medications display in collapsible sections
- [ ] Prescriptions table shows all prescriptions with details
- [ ] Empty states display correctly when no data
- [ ] Provider name displays correctly from joined data
</verification>

<success_criteria>
- Treatment Plan tab shows complete plan overview
- All prescriptions visible in table format with status
- Collapsible sections work for medications
- Empty states handle missing data gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/16-patient-detail-view/16-02-SUMMARY.md`
</output>
