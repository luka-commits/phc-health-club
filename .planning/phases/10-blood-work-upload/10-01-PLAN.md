---
phase: 10-blood-work-upload
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/002_blood_work_storage.sql
  - package.json
  - package-lock.json
autonomous: true
---

<objective>
Set up Supabase Storage infrastructure for blood work PDF uploads with proper RLS policies.

Purpose: Create the storage foundation that enables secure, patient-scoped file uploads for blood work PDFs.
Output: Private storage bucket with RLS policies and required dependencies installed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-blood-work-upload/10-RESEARCH.md

@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase Storage bucket migration</name>
  <files>supabase/migrations/002_blood_work_storage.sql</files>
  <action>
Create SQL migration that:
1. Creates private 'blood-work' bucket in storage.buckets
2. Adds RLS policy for patients to INSERT to their own folder (folder name = patient_id)
3. Adds RLS policy for patients to SELECT their own files
4. Adds RLS policy for providers to SELECT files of their assigned patients (via treatment_plans)

Use storage.foldername(name)[1] to extract patient_id from path.
Path structure: {patient_id}/{uuid}.pdf

Important: The bucket must be private (public = false) for HIPAA compliance.
  </action>
  <verify>cat supabase/migrations/002_blood_work_storage.sql shows bucket creation and 3+ RLS policies</verify>
  <done>Migration file exists with bucket and all RLS policies defined</done>
</task>

<task type="auto">
  <name>Task 2: Install required dependencies</name>
  <files>package.json</files>
  <action>
Install react-dropzone and uuid:
```bash
cd phc-health-club && npm install react-dropzone uuid
```

react-dropzone provides drag-drop file upload UI with accessibility support.
uuid generates unique filenames to prevent collisions.
  </action>
  <verify>grep -E "react-dropzone|uuid" package.json shows both dependencies</verify>
  <done>react-dropzone and uuid listed in package.json dependencies</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file exists at supabase/migrations/002_blood_work_storage.sql
- [ ] Migration creates 'blood-work' bucket as private
- [ ] Migration includes INSERT, SELECT policies for patients
- [ ] Migration includes SELECT policy for providers
- [ ] package.json includes react-dropzone and uuid
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Storage infrastructure ready for upload feature implementation
</success_criteria>

<output>
After completion, create `.planning/phases/10-blood-work-upload/10-01-SUMMARY.md`
</output>
