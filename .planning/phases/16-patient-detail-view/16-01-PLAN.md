---
phase: 16-patient-detail-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/provider/patients/[id]/page.tsx
  - src/components/provider/patient-detail/patient-info-card.tsx
  - src/components/provider/patient-detail/edit-patient-dialog.tsx
  - src/lib/actions/patients.ts
autonomous: true
---

<objective>
Create the core patient detail page with patient info section and edit capability.

Purpose: Provider can view complete patient profile and edit patient information from a single detail page.
Output: Working patient detail page at /provider/patients/[id] with patient info tab and edit dialog.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/15-patient-list/15-01-SUMMARY.md

# Existing patterns
@src/app/(dashboard)/provider/patients/page.tsx
@src/app/(dashboard)/patient/settings/profile-form.tsx
@src/components/provider/patient-list.tsx
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create patient detail page with tabs structure</name>
  <files>src/app/(dashboard)/provider/patients/[id]/page.tsx</files>
  <action>
Create server component page that:
1. Gets current user via getDBUser() - must be provider or admin
2. Fetches patient by ID with full data:
   - patients table with user join (first_name, last_name, email, phone, avatar_url)
   - date_of_birth, shipping_address, billing_address, insurance_info, intake_form_data, intake_completed
3. Verify provider has access to this patient:
   - MD/Admin: always has access
   - PA/NP: only if they have treatment plan for this patient
4. Use PageHeader with patient name and back button to /provider/patients
5. Create Tabs component with 4 tabs: "Overview", "Treatment Plan", "Blood Work", "Lifestyle & Notes"
6. Overview tab contains PatientInfoCard component
7. Other tabs show placeholder text for now (will be implemented in subsequent plans)
8. Handle 404 case when patient not found

Follow existing pattern from patient settings page for tab structure.
Use Badge to show intake status.
  </action>
  <verify>npm run build succeeds, page accessible at /provider/patients/[id]</verify>
  <done>Patient detail page renders with tabs, shows patient overview info</done>
</task>

<task type="auto">
  <name>Task 2: Create PatientInfoCard component</name>
  <files>src/components/provider/patient-detail/patient-info-card.tsx</files>
  <action>
Create client component that displays patient information in organized sections:

1. Profile Section (Card):
   - Avatar with initials fallback
   - Full name, email, phone
   - Date of birth with age calculation
   - Member since date (created_at)
   - Intake status badge

2. Addresses Section (Card with 2 columns):
   - Shipping address (formatted street, city, state, zip)
   - Billing address (formatted or "Same as shipping" if identical)
   - Empty state if no addresses

3. Insurance Section (Card):
   - Display insurance_info JSON in readable format
   - Provider name, policy number, group number if available
   - Empty state if no insurance info

4. Edit button in header that opens EditPatientDialog

Props interface:
- patient: Patient (with user data embedded)
- canEdit: boolean (passed from server based on role permissions)

Use existing Card, Badge, Avatar components from shadcn/ui.
Format phone numbers and dates consistently.
  </action>
  <verify>Component renders all patient data sections correctly</verify>
  <done>PatientInfoCard displays all patient info in organized cards with edit trigger</done>
</task>

<task type="auto">
  <name>Task 3: Create EditPatientDialog and server action</name>
  <files>src/components/provider/patient-detail/edit-patient-dialog.tsx, src/lib/actions/patients.ts</files>
  <action>
Create server action in src/lib/actions/patients.ts:
- updatePatientInfo(patientId: string, data: PatientUpdateInput)
- Verify caller is provider/admin
- For PA/NP: verify they have treatment plan for this patient
- Update users table (first_name, last_name, phone)
- Update patients table (date_of_birth, shipping_address, billing_address, insurance_info)
- Return { success: true } | { success: false, error: string }

Create client component EditPatientDialog:
1. Dialog triggered by Edit button
2. Form with react-hook-form + zod validation
3. Tabs or sections for:
   - Basic Info (first_name, last_name, phone, date_of_birth)
   - Shipping Address (street, city, state, zip, country)
   - Billing Address (street, city, state, zip, country) with "same as shipping" checkbox
   - Insurance Info (provider_name, policy_number, group_number as editable fields)
4. Submit calls server action
5. On success: toast + close dialog + router.refresh()

Use existing form patterns from profile-form.tsx and address-form.tsx.
Validation schema should match existing profileSchema pattern.
  </action>
  <verify>Dialog opens, form validates, server action updates patient, page refreshes with new data</verify>
  <done>Provider can edit patient info through dialog, changes persist to database</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] /provider/patients/[id] loads patient data correctly
- [ ] MD/Admin can access any patient
- [ ] PA/NP can only access their assigned patients
- [ ] PatientInfoCard shows all data sections
- [ ] Edit dialog opens and saves changes
- [ ] 404 handled for non-existent patients
</verification>

<success_criteria>
- Patient detail page accessible from patient list cards
- All patient info displayed (profile, addresses, insurance)
- Edit functionality works for authorized providers
- Tab structure ready for additional content
</success_criteria>

<output>
After completion, create `.planning/phases/16-patient-detail-view/16-01-SUMMARY.md`
</output>
